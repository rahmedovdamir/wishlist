
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="WishList">
    <link rel="apple-touch-icon" href="{% static 'icons/wishlist.png' %}">
    <title>{% block title %}WishList{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="{% static 'main.css' %}">
    <link rel="manifest" href="{% static 'manifest.json' %}" />
</head>
<body class="bg-white">
    <!-- Mobile Menu Overlay -->
    <div id="overlay" class="overlay fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden"></div>
    
    <!-- Mobile Menu -->
    <div id="mobileMenu" class="mobile-menu fixed top-0 left-0 w-80 h-full bg-white z-50 md:hidden shadow-lg">
        <div class="p-6">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-lg font-bold tracking-tight">
                    WishList 
                </h2>   
                <button id="closeMenu" class="hamburger active">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            
            <nav class="space-y-6">
                <a href="{% url 'main:index' %}" 
                   hx-get="{% url 'main:index' %}" 
                   hx-target="#main-content" 
                   hx-push-url="true"
                   class="mobile-nav-link block text-lg font-medium text-gray-900 hover:text-gray-700 py-2 border-b border-gray-200">
                   Главная
                </a>
                <a href="{% url 'main:catalog_all' %}" 
                    hx-get="{% url 'main:catalog_all' %}" 
                    hx-target="#main-content" 
                    hx-push-url="true"
                    class="mobile-nav-link block text-lg font-medium text-gray-900 hover:text-gray-700 py-2 border-b border-gray-200 {% if not current_category %}active{% endif %}">
                    Идеи
                </a>
            </nav>
                <div class="mt-8 space-y-4">
                <a href="#" class="block text-sm font-medium text-gray-900 hover:text-gray-700 py-2">SEARCH</a>
                <a href="{% url 'users:profile' %}" 
                hx-get="{% url 'users:profile' %}" 
                hx-target="#main-content" 
                hx-push-url="true"
                class="text-sm font-medium text-gray-900 uppercase hover:text-gray-600">
                    Аккаунт
                </a>
                    {% if request.user.is_authenticated %}
                    <a href="{% url 'users:profile_products_view' request.user.login %}" 
                        hx-get="{% url 'users:profile_products_view' request.user.login %}" 
                        hx-target="#main-content" 
                        hx-push-url="true"
                        class="text-sm font-medium text-gray-900 uppercase hover:text-gray-600">
                        MyWISHES
                    </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="sticky top-0">
        <div class="mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Mobile Menu Button -->
                <button id="menuToggle" class="hamburger md:hidden">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                
                <!-- Logo -->
                <div class="flex-shrink-0">
                    <a href="{% url 'main:index' %}" 
                       hx-get="{% url 'main:index' %}" 
                       hx-target="#main-content" 
                       hx-push-url="true">
                        <h1 class="text-sm sm:text-lg font-bold tracking-tight text-left">
                            WishList
                        </h1>
                    </a>
                </div>
                
                <!-- Desktop Navigation -->

                <!-- Right side links -->
                <div class="hidden md:flex items-center space-x-6">
                    <div class="relative" id="mobile-search-wrapper">
                        <button id="mobile-search-toggle" 
                                hx-get="{% url 'main:catalog_all' %}?show_search=true" 
                                hx-target="#mobile-search-wrapper" 
                                hx-swap="innerHTML"
                                class="text-sm font-medium uppercase hover:text-gray-600">
                            Поиск
                        </button>
                    </div>
                    <a href="{% url 'users:profile' %}" 
                    hx-get="{% url 'users:profile' %}" 
                    hx-target="#main-content" 
                    hx-push-url="true"
                    class="text-sm font-medium text-gray-900 uppercase hover:text-gray-600">
                        Аккаунт
                    </a>
                    {% if request.user.is_authenticated %}
                    <a href="{% url 'users:profile_products_view' request.user.login %}" 
                        hx-get="{% url 'users:profile_products_view' request.user.login %}" 
                        hx-target="#main-content" 
                        hx-push-url="true"
                        class="text-sm font-medium text-gray-900 uppercase hover:text-gray-600">
                        MyWISHES
                    </a>
                    {% endif %}
                </div>
                
                <!-- Mobile Cart Icon -->
                <div class="md:hidden">
                    {% if request.user.is_authenticated %}
                    <a href="{% url 'users:profile_products_view' request.user.login %}" 
                        hx-get="{% url 'users:profile_products_view' request.user.login %}" 
                        hx-target="#main-content" 
                        hx-push-url="true"
                        class="text-sm font-medium text-gray-900 uppercase hover:text-gray-600">
                        MyWISHES
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </header>
    <div id="cart-container"></div>

    <!-- Loading Indicator -->
    <div class="htmx-indicator fixed top-0 left-0 w-full h-1 bg-black z-50"></div>

    <!-- Main Content -->
    <div id="main-content">
        {% block content %}
        <!-- Default home content -->
        {% endblock %}
    </div>
<script>
function initServiceWorker() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('{% static "sw.js" %}')
            .then(registration => console.log('SW registered:', registration))
            .catch(error => console.log('SW registration failed:', error));
    }
}
// Глобальные функции
function initMobileMenu() {
    const menuToggle = document.getElementById('menuToggle');
    const closeMenu = document.getElementById('closeMenu');
    const mobileMenu = document.getElementById('mobileMenu');
    const overlay = document.getElementById('overlay');

    if (!menuToggle || !mobileMenu) return;
    function openMobileMenu() {
        mobileMenu.classList.add('open');
        if (overlay) overlay.classList.add('active');
        menuToggle.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeMobileMenu() {
        mobileMenu.classList.remove('open');
        if (overlay) overlay.classList.remove('active');
        menuToggle.classList.remove('active');
        document.body.style.overflow = '';
    }

    menuToggle.onclick = openMobileMenu;
    if (closeMenu) closeMenu.onclick = closeMobileMenu;
    if (overlay) overlay.onclick = closeMobileMenu;
}

function updateActiveNavLinks() {
    const currentPath = window.location.pathname;
    const navLinks = document.querySelectorAll('.nav-link, .mobile-nav-link');
    
    navLinks.forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('href') === currentPath) {
            link.classList.add('active');
        }
    });
}

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    initMobileMenu();
    updateActiveNavLinks();
    initServiceWorker();
});

// Переинициализация после HTMX
document.addEventListener('htmx:afterSettle', function() {
    setTimeout(() => {
        initMobileMenu();
        updateActiveNavLinks();
    }, 100);
});

// Закрытие меню при навигации
document.addEventListener('htmx:beforeRequest', function() {
    const mobileMenu = document.getElementById('mobileMenu');
    if (mobileMenu && mobileMenu.classList.contains('open')) {
        mobileMenu.classList.remove('open');
        document.getElementById('overlay')?.classList.remove('active');
        document.getElementById('menuToggle')?.classList.remove('active');
        document.body.style.overflow = '';
    }
});

// Функции для корзины
document.addEventListener('cartUpdated', function(e) {
    if (e.detail?.total_items !== undefined) {
        updateHeaderCartCount(e.detail.total_items);
    }
});

window.updateHeaderCartCount = function(count) {
    const elements = [
        document.getElementById('desktopCart'),
        document.getElementById('mobileCart'),
        document.getElementById('mobileCartHeader')
    ];
    const cartText = `CART (${count})`;
    
    elements.forEach(el => {
        if (el) el.textContent = cartText;
    });
};
</script>
</body>
</html>